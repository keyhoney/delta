<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지 - 대구수학페스티벌</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Δ</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Δ</div>
            <div>
                <h1>대구수학페스티벌</h1>
                <div class="subtitle">송현여자고등학교 Delta 부스 - 관리자</div>
            </div>
        </header>

        <div class="card">
            <h2>예약 관리 시스템</h2>
            <div class="description">시간대별 예약 현황을 조회하고 관리합니다</div>
        </div>

        <!-- 비밀번호 입력 모달 -->
        <div id="passwordModal" class="modal" style="display: block;">
            <div class="modal-content">
                <h3>관리자 인증</h3>
                <div class="form-group">
                    <label>비밀번호</label>
                    <input type="password" id="adminPassword" placeholder="비밀번호를 입력하세요" />
                </div>
                <button class="btn btn-primary" id="btnLogin">로그인</button>
                <div id="passwordError" class="text-small" style="color: var(--error-500); margin-top: var(--space-3); display: none;">
                    비밀번호가 올바르지 않습니다.
                </div>
            </div>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- 통계 대시보드 -->
            <div class="card">
                <h3>통계 대시보드</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-reservations">-</div>
                        <div class="stat-label">전체 예약</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-people">-</div>
                        <div class="stat-label">총 인원</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="completed-count">-</div>
                        <div class="stat-label">완료된 체험</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pending-count">-</div>
                        <div class="stat-label">대기 중</div>
                    </div>
                </div>
            </div>

            <!-- 프로그램 선택 -->
            <div class="card">
                <h3>프로그램 선택</h3>
                <div class="program-tabs">
                    <button class="tab-btn active" data-program="keyring">비즈 키링</button>
                    <button class="tab-btn" data-program="magnet">비즈 마그넷</button>
                </div>
            </div>

            <!-- 시간대별 현황 -->
            <div class="card">
                <h3>시간대별 예약 현황</h3>
                <div class="time-slot-grid" id="timeSlotGrid">
                    <!-- 시간대별 슬롯이 여기에 동적으로 생성됩니다 -->
                </div>
            </div>

            <!-- 예약자 목록 -->
            <div class="card">
                <h3>예약자 목록</h3>
                <div class="table-container">
                    <table class="table" id="reservationsTable">
                        <thead>
                            <tr>
                                <th>시간대</th>
                                <th>연락처</th>
                                <th>인원</th>
                            </tr>
                        </thead>
                        <tbody id="reservationsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, query, where, orderBy, getDocs, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyA_YlXZRedGE4dHiIwZ40yc8GDaCoen0Pc",
            authDomain: "delta-3bf19.firebaseapp.com",
            projectId: "delta-3bf19",
            storageBucket: "delta-3bf19.firebasestorage.app",
            messagingSenderId: "975459775271",
            appId: "1:975459775271:web:87d105fecef201e2f96f02"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const RES_COL = collection(db, 'reservations');

        let isAuthenticated = false;
        let selectedProgram = 'keyring';
        let allReservations = [];
        let refreshInterval;

        // 비밀번호 인증
        function authenticate(password) {
            return password === '0000';
        }

        // 로그인 처리
        document.getElementById('btnLogin').addEventListener('click', () => {
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('passwordError');
            
            if (authenticate(password)) {
                isAuthenticated = true;
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                loadData();
                startAutoRefresh();
            } else {
                errorDiv.style.display = 'block';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        });

        // Enter 키로 로그인
        document.getElementById('adminPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('btnLogin').click();
            }
        });

        // 시간대 생성 함수
        function generateTimeSlots() {
            const slots = [];
            for (let hour = 9; hour <= 17; hour++) {
                for (let minute = 0; minute < 60; minute += 10) {
                    if (hour === 17 && minute > 50) break;
                    if (hour === 9 && minute < 30) continue;
                    
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    slots.push(timeString);
                }
            }
            return slots;
        }

        // 현재 시간대 찾기
        function getCurrentTimeSlot() {
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${Math.floor(now.getMinutes() / 10) * 10}`;
            return currentTime;
        }

        // 데이터 로드
        async function loadData() {
            try {
                const q = query(RES_COL, orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                allReservations = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                updateStatistics();
                updateTimeSlotGrid();
                updateReservationsTable();
                
            } catch (error) {
                console.error('데이터 로드 중 오류:', error);
            }
        }

        // 통계 업데이트
        function updateStatistics() {
            const totalReservations = allReservations.length;
            const totalPeople = allReservations.reduce((sum, res) => sum + (res.count || 0), 0);
            const completedCount = allReservations.filter(res => res.status === 'done').length;
            const pendingCount = allReservations.filter(res => res.status === 'pending').length;

            document.getElementById('total-reservations').textContent = totalReservations;
            document.getElementById('total-people').textContent = totalPeople;
            document.getElementById('completed-count').textContent = completedCount;
            document.getElementById('pending-count').textContent = pendingCount;
        }

        // 시간대별 그리드 업데이트
        function updateTimeSlotGrid() {
            const timeSlots = generateTimeSlots();
            const currentTime = getCurrentTimeSlot();
            const grid = document.getElementById('timeSlotGrid');
            
            grid.innerHTML = timeSlots.map(slot => {
                const slotReservations = allReservations.filter(res => 
                    res.programType === selectedProgram && 
                    res.timeSlot === slot && 
                    res.status === 'pending'
                );
                const count = slotReservations.reduce((sum, res) => sum + (res.count || 0), 0);
                const isCurrent = slot === currentTime;
                const isPast = slot < currentTime;
                
                let statusClass = 'slot-available';
                if (count >= 4) statusClass = 'slot-full';
                else if (count >= 3) statusClass = 'slot-almost-full';
                else if (count >= 2) statusClass = 'slot-moderate';
                
                return `
                    <div class="time-slot-admin ${statusClass} ${isCurrent ? 'current' : ''} ${isPast ? 'past' : ''}" 
                         data-slot="${slot}" 
                         data-count="${count}">
                        <div class="slot-time">${slot}</div>
                        <div class="slot-count">${count}/4명</div>
                        ${isCurrent ? '<div class="current-indicator">현재</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        // 예약자 목록 업데이트
        function updateReservationsTable() {
            const programReservations = allReservations.filter(res => res.programType === selectedProgram);
            const tbody = document.getElementById('reservationsTableBody');
            
            if (programReservations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">예약이 없습니다.</td></tr>';
                return;
            }
            
            // 시간대별로 정렬 (늦은 시간이 위에)
            const sortedReservations = programReservations.sort((a, b) => {
                return b.timeSlot.localeCompare(a.timeSlot);
            });
            
            tbody.innerHTML = sortedReservations.map(res => {
                return `
                    <tr>
                        <td>${res.timeSlot}</td>
                        <td>${res.contact}</td>
                        <td>${res.count}명</td>
                    </tr>
                `;
            }).join('');
        }

        // 상태 변경
        async function updateReservationStatus(reservationId, status) {
            try {
                const docRef = doc(db, 'reservations', reservationId);
                await updateDoc(docRef, {
                    status: status,
                    updatedAt: serverTimestamp()
                });
                
                // 로컬 데이터 업데이트
                const index = allReservations.findIndex(res => res.id === reservationId);
                if (index !== -1) {
                    allReservations[index].status = status;
                }
                
                updateStatistics();
                updateTimeSlotGrid();
                updateReservationsTable();
                
            } catch (error) {
                console.error('상태 변경 중 오류:', error);
                alert('상태 변경 중 오류가 발생했습니다.');
            }
        }

        // 메모 저장
        async function saveAdminNote(reservationId, note) {
            try {
                const docRef = doc(db, 'reservations', reservationId);
                await updateDoc(docRef, {
                    adminNote: note,
                    updatedAt: serverTimestamp()
                });
                
                // 로컬 데이터 업데이트
                const index = allReservations.findIndex(res => res.id === reservationId);
                if (index !== -1) {
                    allReservations[index].adminNote = note;
                }
                
            } catch (error) {
                console.error('메모 저장 중 오류:', error);
            }
        }

        // 이벤트 리스너 설정
        document.addEventListener('DOMContentLoaded', () => {
            // 프로그램 탭 클릭
            document.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedProgram = e.target.dataset.program;
                    updateTimeSlotGrid();
                    updateReservationsTable();
                }
            });

            // 시간대 슬롯 클릭
            document.addEventListener('click', (e) => {
                if (e.target.matches('.time-slot-admin')) {
                    const slot = e.target.dataset.slot;
                    // 해당 시간대의 예약만 필터링하여 표시
                    const slotReservations = allReservations.filter(res => 
                        res.programType === selectedProgram && 
                        res.timeSlot === slot
                    );
                    
                    if (slotReservations.length > 0) {
                        // 시간대별 예약자 목록 표시 (모달 또는 별도 섹션)
                        showSlotReservations(slot, slotReservations);
                    }
                }
            });

            // 이벤트 리스너는 시간대 슬롯 클릭만 유지
        });

        // 시간대별 예약자 표시
        function showSlotReservations(slot, reservations) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>${slot} 예약자 목록</h3>
                    <div class="slot-reservations">
                        ${reservations.map(res => `
                            <div class="reservation-item">
                                <div class="reservation-info">
                                    <strong>연락처:</strong> ${res.contact}<br>
                                    <strong>인원:</strong> ${res.count}명
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-primary" onclick="this.closest('.modal').remove()">닫기</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // 자동 새로고침
        function startAutoRefresh() {
            refreshInterval = setInterval(loadData, 10000); // 10초마다
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }
    </script>
</body>
</html>