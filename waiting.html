<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 예약 현황 - 대구수학페스티벌</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Δ</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Δ</div>
            <div>
                <h1>대구수학페스티벌</h1>
                <div class="subtitle">송현여자고등학교 Delta 부스</div>
            </div>
        </header>

        <div class="card">
            <h2>내 예약 확인</h2>
            <div class="description">연락처로 예약 내역을 조회하고 수정할 수 있습니다</div>
        </div>

        <div class="card">
            <div class="form-group">
                <label>휴대폰 번호</label>
                <input id="phone" type="tel" inputmode="numeric" placeholder="010-0000-0000" value="010-" />
            </div>
            <button class="btn btn-primary" id="btn-check">조회</button>
            <a href="./index.html" style="margin-left: var(--space-3); text-decoration: none;">
                <button class="btn btn-secondary">예약하러 가기</button>
            </a>
        </div>

        <div class="card" id="result" style="display:none"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, query, where, orderBy, getDocs, doc, deleteDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyA_YlXZRedGE4dHiIwZ40yc8GDaCoen0Pc",
            authDomain: "delta-3bf19.firebaseapp.com",
            projectId: "delta-3bf19",
            storageBucket: "delta-3bf19.firebasestorage.app",
            messagingSenderId: "975459775271",
            appId: "1:975459775271:web:87d105fecef201e2f96f02"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const RES_COL = collection(db, 'reservations');

        const el = id => document.getElementById(id);

        // URL 파라미터에서 전화번호 가져오기
        function getParam(name) {
            const url = new URL(location.href);
            return url.searchParams.get(name);
        }
        const pre = getParam('phone');
        if (pre) {
            el('phone').value = formatPhoneNumber(pre);
        }

        // 전화번호 포맷팅 함수
        function formatPhoneNumber(phone) {
            const numbers = phone.replace(/[^0-9]/g, '');
            let formatted = numbers;
            if (!formatted.startsWith('010')) {
                formatted = '010' + formatted;
            }
            formatted = formatted.substring(0, 11);
            
            if (formatted.length >= 3) {
                formatted = formatted.substring(0, 3) + '-' + formatted.substring(3);
            }
            if (formatted.length >= 8) {
                formatted = formatted.substring(0, 8) + '-' + formatted.substring(8);
            }
            
            return formatted;
        }

        // 전화번호 정규화 함수
        function normalizePhone(phone) {
            return phone.replace(/[^0-9]/g, '');
        }

        // 전화번호 입력 이벤트 처리
        el('phone').addEventListener('input', (e) => {
            const input = e.target;
            const cursorPosition = input.selectionStart;
            const oldValue = input.value;
            const oldLength = oldValue.length;
            
            const formatted = formatPhoneNumber(input.value);
            input.value = formatted;
            
            const newLength = formatted.length;
            let newPosition = cursorPosition;
            
            if (newLength > oldLength) {
                newPosition += newLength - oldLength;
            } else if (newLength < oldLength) {
                newPosition -= oldLength - newLength;
            }
            
            input.setSelectionRange(newPosition, newPosition);
        });

        // 숫자만 입력 가능
        el('phone').addEventListener('keypress', (e) => {
            const char = String.fromCharCode(e.which);
            if (!/[0-9]/.test(char)) {
                e.preventDefault();
            }
        });

        // 예약 조회 및 표시
        document.getElementById('btn-check').addEventListener('click', async () => {
            const phone = normalizePhone(el('phone').value);
            if (!/^01\d{8,9}$/.test(phone)) { 
                alert('휴대폰 번호 형식을 확인해주세요.'); 
                return; 
            }

            try {
                // 해당 전화번호의 모든 예약 조회
                const q = query(RES_COL, where('contact', '==', phone), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                
                if (snap.empty) { 
                    alert('예약 내역이 없습니다.'); 
                    return; 
                }

                const reservations = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const box = el('result');
                
                if (reservations.length === 0) {
                    box.innerHTML = '<div class="text-small">예약 내역이 없습니다.</div>';
                } else {
                    box.innerHTML = reservations.map(res => {
                        const programLabel = res.programType === 'keyring' ? '비즈 키링' : '비즈 마그넷';
                        const statusText = res.status === 'pending' ? '대기중' : 
                                         res.status === 'done' ? '체험 완료' : 
                                         res.status === 'cancelled' ? '취소됨' : 
                                         res.status === 'noshow' ? '노쇼' : res.status;
                        
                        return `
                            <div class="reservation-item">
                                <div class="reservation-header">
                                    <span class="badge">${programLabel}</span>
                                    <span class="reservation-time">${res.timeSlot}</span>
                                </div>
                                <div class="reservation-details">
                                    <div class="reservation-info">
                                        <strong>상태:</strong> 
                                        <span class="status-${res.status}">${statusText}</span>
                                    </div>
                                    <div class="reservation-info">
                                        <strong>인원:</strong> ${res.count}명
                                    </div>
                                    <div class="reservation-info">
                                        <strong>예약 시간:</strong> ${res.timeSlot}
                                    </div>
                                </div>
                                <div class="reservation-actions">
                                    ${res.status === 'pending' ? `
                                        <button class="btn btn-secondary" data-action="edit" data-id="${res.id}">
                                            수정하기
                                        </button>
                                        <button class="btn btn-secondary" data-action="cancel" data-id="${res.id}">
                                            예약 취소
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                box.style.display = 'block';
                
            } catch (error) {
                console.error('예약 조회 중 오류:', error);
                alert('예약 조회 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        });

        // 예약 수정 모달
        function showEditModal(reservation) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>예약 수정</h3>
                    <div class="form-group">
                        <label>프로그램</label>
                        <div class="text-small">${reservation.programType === 'keyring' ? '비즈 키링' : '비즈 마그넷'}</div>
                    </div>
                    <div class="form-group">
                        <label>시간대</label>
                        <select id="edit-timeSlot">
                            <!-- 시간대 옵션이 여기에 동적으로 추가됩니다 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>인원 수</label>
                        <input id="edit-count" type="number" min="1" max="4" value="${reservation.count}" />
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" id="save-edit">저장</button>
                        <button class="btn btn-secondary" id="cancel-edit">취소</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 시간대 옵션 로드
            loadTimeSlotOptions(reservation.programType, reservation.timeSlot);
            
            // 이벤트 리스너
            document.getElementById('save-edit').addEventListener('click', async () => {
                await saveReservationEdit(reservation.id, modal);
            });
            
            document.getElementById('cancel-edit').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        // 시간대 옵션 로드
        async function loadTimeSlotOptions(programType, currentTimeSlot) {
            try {
                const q = query(RES_COL, where('programType', '==', programType));
                const snap = await getDocs(q);
                const reservations = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 시간대별 예약 인원 계산
                const slotCounts = {};
                reservations.forEach(res => {
                    if (res.status === 'pending') {
                        slotCounts[res.timeSlot] = (slotCounts[res.timeSlot] || 0) + res.count;
                    }
                });
                
                // 시간대 옵션 생성
                const timeSlots = generateTimeSlots();
                const select = document.getElementById('edit-timeSlot');
                select.innerHTML = timeSlots.map(slot => {
                    const count = slotCounts[slot] || 0;
                    const remaining = 4 - count;
                    const isDisabled = remaining <= 0;
                    const isCurrent = slot === currentTimeSlot;
                    
                    return `<option value="${slot}" ${isCurrent ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}>
                        ${slot} ${isDisabled ? '(마감)' : `(${remaining}명 남음)`}
                    </option>`;
                }).join('');
                
            } catch (error) {
                console.error('시간대 옵션 로드 중 오류:', error);
            }
        }

        // 시간대 생성 함수
        function generateTimeSlots() {
            const slots = [];
            for (let hour = 9; hour <= 17; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    if (hour === 17 && minute > 45) break;
                    if (hour === 9 && minute < 30) continue;
                    
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    slots.push(timeString);
                }
            }
            return slots;
        }

        // 예약 수정 저장
        async function saveReservationEdit(reservationId, modal) {
            const newTimeSlot = document.getElementById('edit-timeSlot').value;
            const newCount = parseInt(document.getElementById('edit-count').value);
            
            if (!newTimeSlot || newCount <= 0) {
                alert('모든 필드를 올바르게 입력해주세요.');
                return;
            }
            
            try {
                // 먼저 현재 예약 정보를 조회하여 programType 확인
                const currentReservationRef = doc(db, 'reservations', reservationId);
                const currentReservationSnap = await getDocs(query(RES_COL, where('__name__', '==', reservationId)));
                if (currentReservationSnap.empty) {
                    alert('예약 정보를 찾을 수 없습니다.');
                    return;
                }
                const currentReservation = { id: currentReservationSnap.docs[0].id, ...currentReservationSnap.docs[0].data() };
                const programType = currentReservation.programType;
                
                // 🔥 핵심: 해당 시간대의 현재 예약 현황 조회
                const q = query(RES_COL, 
                    where('programType', '==', programType),
                    where('timeSlot', '==', newTimeSlot),
                    where('status', '==', 'pending')
                );
                const snap = await getDocs(q);
                const currentReservations = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 현재 예약된 총 인원 계산
                const currentTotal = currentReservations.reduce((sum, res) => sum + (res.count || 0), 0);
                
                // 내 예약을 제외한 인원 계산
                const otherReservations = currentReservations.filter(res => res.id !== reservationId);
                const otherTotal = otherReservations.reduce((sum, res) => sum + (res.count || 0), 0);
                
                // 잔여 인원 확인
                const remainingSlots = 4 - otherTotal;
                
                if (newCount > remainingSlots) {
                    alert(`해당 시간대는 최대 ${remainingSlots}명까지 예약 가능합니다.\n현재 다른 예약: ${otherTotal}명`);
                    return;
                }
                
                // 수정 진행
                const docRef = doc(db, 'reservations', reservationId);
                await updateDoc(docRef, {
                    timeSlot: newTimeSlot,
                    count: newCount,
                    updatedAt: serverTimestamp()
                });
                
                alert('예약이 성공적으로 수정되었습니다.');
                document.body.removeChild(modal);
                
                // 결과 새로고침
                document.getElementById('btn-check').click();
                
            } catch (error) {
                console.error('예약 수정 중 오류:', error);
                alert('예약 수정 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        // 예약 취소
        async function cancelReservation(reservationId) {
            if (!confirm('정말로 이 예약을 취소하시겠습니까?\n\n취소된 예약은 복구할 수 없습니다.')) {
                return;
            }

            try {
                const docRef = doc(db, 'reservations', reservationId);
                await updateDoc(docRef, {
                    status: 'cancelled',
                    cancelledAt: serverTimestamp()
                });
                
                alert('예약이 성공적으로 취소되었습니다.');
                
                // 결과 새로고침
                document.getElementById('btn-check').click();
                
            } catch (error) {
                console.error('예약 취소 중 오류:', error);
                alert('예약 취소 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        // 버튼 클릭 이벤트 처리
        document.addEventListener('click', async (e) => {
            if (e.target.matches('[data-action="edit"]')) {
                const reservationId = e.target.dataset.id;
                // 예약 정보 조회 후 수정 모달 표시
                const q = query(RES_COL, where('__name__', '==', reservationId));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    const reservation = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    showEditModal(reservation);
                }
            } else if (e.target.matches('[data-action="cancel"]')) {
                const reservationId = e.target.dataset.id;
                await cancelReservation(reservationId);
            }
        });
    </script>
</body>

</html>
