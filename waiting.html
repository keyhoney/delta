<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì˜ˆì•½ í˜„í™© - ëŒ€êµ¬ìˆ˜í•™í˜ìŠ¤í‹°ë²Œ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Î”</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Î”</div>
            <div>
                <h1>ëŒ€êµ¬ìˆ˜í•™í˜ìŠ¤í‹°ë²Œ</h1>
                <div class="subtitle">ì†¡í˜„ì—¬ìê³ ë“±í•™êµ Delta ë¶€ìŠ¤</div>
            </div>
        </header>

        <div class="card">
            <h2>ë‚´ ì˜ˆì•½ í™•ì¸</h2>
            <div class="description">ì—°ë½ì²˜ë¡œ ì˜ˆì•½ ë‚´ì—­ì„ ì¡°íšŒí•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
        </div>

        <div class="card">
            <div class="form-group">
                <label>íœ´ëŒ€í° ë²ˆí˜¸</label>
                <input id="phone" type="tel" inputmode="numeric" placeholder="010-0000-0000" value="010-" />
            </div>
            <button class="btn btn-primary" id="btn-check">ì¡°íšŒ</button>
            <a href="./index.html" style="margin-left: var(--space-3); text-decoration: none;">
                <button class="btn btn-secondary">ì˜ˆì•½í•˜ëŸ¬ ê°€ê¸°</button>
            </a>
        </div>

        <div class="card" id="result" style="display:none"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, query, where, orderBy, getDocs, doc, deleteDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyA_YlXZRedGE4dHiIwZ40yc8GDaCoen0Pc",
            authDomain: "delta-3bf19.firebaseapp.com",
            projectId: "delta-3bf19",
            storageBucket: "delta-3bf19.firebasestorage.app",
            messagingSenderId: "975459775271",
            appId: "1:975459775271:web:87d105fecef201e2f96f02"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const RES_COL = collection(db, 'reservations');

        const el = id => document.getElementById(id);

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì „í™”ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        function getParam(name) {
            const url = new URL(location.href);
            return url.searchParams.get(name);
        }
        const pre = getParam('phone');
        if (pre) {
            el('phone').value = formatPhoneNumber(pre);
        }

        // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ… í•¨ìˆ˜
        function formatPhoneNumber(phone) {
            const numbers = phone.replace(/[^0-9]/g, '');
            let formatted = numbers;
            if (!formatted.startsWith('010')) {
                formatted = '010' + formatted;
            }
            formatted = formatted.substring(0, 11);
            
            if (formatted.length >= 3) {
                formatted = formatted.substring(0, 3) + '-' + formatted.substring(3);
            }
            if (formatted.length >= 8) {
                formatted = formatted.substring(0, 8) + '-' + formatted.substring(8);
            }
            
            return formatted;
        }

        // ì „í™”ë²ˆí˜¸ ì •ê·œí™” í•¨ìˆ˜
        function normalizePhone(phone) {
            return phone.replace(/[^0-9]/g, '');
        }

        // ì „í™”ë²ˆí˜¸ ì…ë ¥ ì´ë²¤íŠ¸ ì²˜ë¦¬
        el('phone').addEventListener('input', (e) => {
            const input = e.target;
            const cursorPosition = input.selectionStart;
            const oldValue = input.value;
            const oldLength = oldValue.length;
            
            const formatted = formatPhoneNumber(input.value);
            input.value = formatted;
            
            const newLength = formatted.length;
            let newPosition = cursorPosition;
            
            if (newLength > oldLength) {
                newPosition += newLength - oldLength;
            } else if (newLength < oldLength) {
                newPosition -= oldLength - newLength;
            }
            
            input.setSelectionRange(newPosition, newPosition);
        });

        // ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥
        el('phone').addEventListener('keypress', (e) => {
            const char = String.fromCharCode(e.which);
            if (!/[0-9]/.test(char)) {
                e.preventDefault();
            }
        });

        // ì˜ˆì•½ ì¡°íšŒ ë° í‘œì‹œ
        document.getElementById('btn-check').addEventListener('click', async () => {
            const phone = normalizePhone(el('phone').value);
            if (!/^01\d{8,9}$/.test(phone)) { 
                alert('íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'); 
                return; 
            }

            try {
                // í•´ë‹¹ ì „í™”ë²ˆí˜¸ì˜ ëª¨ë“  ì˜ˆì•½ ì¡°íšŒ
                const q = query(RES_COL, where('contact', '==', phone), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                
                if (snap.empty) { 
                    alert('ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.'); 
                    return; 
                }

                const reservations = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const box = el('result');
                
                if (reservations.length === 0) {
                    box.innerHTML = '<div class="text-small">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    box.innerHTML = reservations.map(res => {
                        const programLabel = res.programType === 'keyring' ? 'ë¹„ì¦ˆ í‚¤ë§' : 'ë¹„ì¦ˆ ë§ˆê·¸ë„·';
                        const statusText = res.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' : 
                                         res.status === 'done' ? 'ì²´í—˜ ì™„ë£Œ' : 
                                         res.status === 'cancelled' ? 'ì·¨ì†Œë¨' : 
                                         res.status === 'noshow' ? 'ë…¸ì‡¼' : res.status;
                        
                        return `
                            <div class="reservation-item">
                                <div class="reservation-header">
                                    <span class="badge">${programLabel}</span>
                                    <span class="reservation-time">${res.timeSlot}</span>
                                </div>
                                <div class="reservation-details">
                                    <div class="reservation-info">
                                        <strong>ìƒíƒœ:</strong> 
                                        <span class="status-${res.status}">${statusText}</span>
                                    </div>
                                    <div class="reservation-info">
                                        <strong>ì¸ì›:</strong> ${res.count}ëª…
                                    </div>
                                    <div class="reservation-info">
                                        <strong>ì˜ˆì•½ ì‹œê°„:</strong> ${res.timeSlot}
                                    </div>
                                </div>
                                <div class="reservation-actions">
                                    ${res.status === 'pending' ? `
                                        <button class="btn btn-secondary" data-action="edit" data-id="${res.id}">
                                            ìˆ˜ì •í•˜ê¸°
                                        </button>
                                        <button class="btn btn-secondary" data-action="cancel" data-id="${res.id}">
                                            ì˜ˆì•½ ì·¨ì†Œ
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                box.style.display = 'block';
                
            } catch (error) {
                console.error('ì˜ˆì•½ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì˜ˆì•½ ìˆ˜ì • ëª¨ë‹¬
        function showEditModal(reservation) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>ì˜ˆì•½ ìˆ˜ì •</h3>
                    <div class="form-group">
                        <label>í”„ë¡œê·¸ë¨</label>
                        <div class="text-small">${reservation.programType === 'keyring' ? 'ë¹„ì¦ˆ í‚¤ë§' : 'ë¹„ì¦ˆ ë§ˆê·¸ë„·'}</div>
                    </div>
                    <div class="form-group">
                        <label>ì‹œê°„ëŒ€</label>
                        <select id="edit-timeSlot">
                            <!-- ì‹œê°„ëŒ€ ì˜µì…˜ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì¸ì› ìˆ˜</label>
                        <input id="edit-count" type="number" min="1" max="4" value="${reservation.count}" />
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" id="save-edit">ì €ì¥</button>
                        <button class="btn btn-secondary" id="cancel-edit">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ì‹œê°„ëŒ€ ì˜µì…˜ ë¡œë“œ
            loadTimeSlotOptions(reservation.programType, reservation.timeSlot);
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('save-edit').addEventListener('click', async () => {
                await saveReservationEdit(reservation.id, modal);
            });
            
            document.getElementById('cancel-edit').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        // ì‹œê°„ëŒ€ ì˜µì…˜ ë¡œë“œ
        async function loadTimeSlotOptions(programType, currentTimeSlot) {
            try {
                const q = query(RES_COL, where('programType', '==', programType));
                const snap = await getDocs(q);
                const reservations = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ì‹œê°„ëŒ€ë³„ ì˜ˆì•½ ì¸ì› ê³„ì‚°
                const slotCounts = {};
                reservations.forEach(res => {
                    if (res.status === 'pending') {
                        slotCounts[res.timeSlot] = (slotCounts[res.timeSlot] || 0) + res.count;
                    }
                });
                
                // ì‹œê°„ëŒ€ ì˜µì…˜ ìƒì„±
                const timeSlots = generateTimeSlots();
                const select = document.getElementById('edit-timeSlot');
                select.innerHTML = timeSlots.map(slot => {
                    const count = slotCounts[slot] || 0;
                    const remaining = 4 - count;
                    const isDisabled = remaining <= 0;
                    const isCurrent = slot === currentTimeSlot;
                    
                    return `<option value="${slot}" ${isCurrent ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}>
                        ${slot} ${isDisabled ? '(ë§ˆê°)' : `(${remaining}ëª… ë‚¨ìŒ)`}
                    </option>`;
                }).join('');
                
            } catch (error) {
                console.error('ì‹œê°„ëŒ€ ì˜µì…˜ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        // ì‹œê°„ëŒ€ ìƒì„± í•¨ìˆ˜
        function generateTimeSlots() {
            const slots = [];
            for (let hour = 9; hour <= 17; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    if (hour === 17 && minute > 45) break;
                    if (hour === 9 && minute < 30) continue;
                    
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    slots.push(timeString);
                }
            }
            return slots;
        }

        // ì˜ˆì•½ ìˆ˜ì • ì €ì¥
        async function saveReservationEdit(reservationId, modal) {
            const newTimeSlot = document.getElementById('edit-timeSlot').value;
            const newCount = parseInt(document.getElementById('edit-count').value);
            
            if (!newTimeSlot || newCount <= 0) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // ë¨¼ì € í˜„ì¬ ì˜ˆì•½ ì •ë³´ë¥¼ ì¡°íšŒí•˜ì—¬ programType í™•ì¸
                const currentReservationRef = doc(db, 'reservations', reservationId);
                const currentReservationSnap = await getDocs(query(RES_COL, where('__name__', '==', reservationId)));
                if (currentReservationSnap.empty) {
                    alert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                const currentReservation = { id: currentReservationSnap.docs[0].id, ...currentReservationSnap.docs[0].data() };
                const programType = currentReservation.programType;
                
                // ğŸ”¥ í•µì‹¬: í•´ë‹¹ ì‹œê°„ëŒ€ì˜ í˜„ì¬ ì˜ˆì•½ í˜„í™© ì¡°íšŒ
                const q = query(RES_COL, 
                    where('programType', '==', programType),
                    where('timeSlot', '==', newTimeSlot),
                    where('status', '==', 'pending')
                );
                const snap = await getDocs(q);
                const currentReservations = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // í˜„ì¬ ì˜ˆì•½ëœ ì´ ì¸ì› ê³„ì‚°
                const currentTotal = currentReservations.reduce((sum, res) => sum + (res.count || 0), 0);
                
                // ë‚´ ì˜ˆì•½ì„ ì œì™¸í•œ ì¸ì› ê³„ì‚°
                const otherReservations = currentReservations.filter(res => res.id !== reservationId);
                const otherTotal = otherReservations.reduce((sum, res) => sum + (res.count || 0), 0);
                
                // ì”ì—¬ ì¸ì› í™•ì¸
                const remainingSlots = 4 - otherTotal;
                
                if (newCount > remainingSlots) {
                    alert(`í•´ë‹¹ ì‹œê°„ëŒ€ëŠ” ìµœëŒ€ ${remainingSlots}ëª…ê¹Œì§€ ì˜ˆì•½ ê°€ëŠ¥í•©ë‹ˆë‹¤.\ní˜„ì¬ ë‹¤ë¥¸ ì˜ˆì•½: ${otherTotal}ëª…`);
                    return;
                }
                
                // ìˆ˜ì • ì§„í–‰
                const docRef = doc(db, 'reservations', reservationId);
                await updateDoc(docRef, {
                    timeSlot: newTimeSlot,
                    count: newCount,
                    updatedAt: serverTimestamp()
                });
                
                alert('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.body.removeChild(modal);
                
                // ê²°ê³¼ ìƒˆë¡œê³ ì¹¨
                document.getElementById('btn-check').click();
                
            } catch (error) {
                console.error('ì˜ˆì•½ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì˜ˆì•½ ì·¨ì†Œ
        async function cancelReservation(reservationId) {
            if (!confirm('ì •ë§ë¡œ ì´ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì·¨ì†Œëœ ì˜ˆì•½ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                const docRef = doc(db, 'reservations', reservationId);
                await updateDoc(docRef, {
                    status: 'cancelled',
                    cancelledAt: serverTimestamp()
                });
                
                alert('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // ê²°ê³¼ ìƒˆë¡œê³ ì¹¨
                document.getElementById('btn-check').click();
                
            } catch (error) {
                console.error('ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.addEventListener('click', async (e) => {
            if (e.target.matches('[data-action="edit"]')) {
                const reservationId = e.target.dataset.id;
                // ì˜ˆì•½ ì •ë³´ ì¡°íšŒ í›„ ìˆ˜ì • ëª¨ë‹¬ í‘œì‹œ
                const q = query(RES_COL, where('__name__', '==', reservationId));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    const reservation = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    showEditModal(reservation);
                }
            } else if (e.target.matches('[data-action="cancel"]')) {
                const reservationId = e.target.dataset.id;
                await cancelReservation(reservationId);
            }
        });
    </script>
</body>

</html>
