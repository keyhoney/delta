<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대구수학페스티벌 - Delta 부스 예약</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Δ</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Δ</div>
            <div>
                <h1>대구수학페스티벌</h1>
                <div class="subtitle">송현여자고등학교 Delta 부스</div>
            </div>
        </header>

        <div class="card">
            <h2>체험 프로그램 선택</h2>
            <div class="description">원하는 체험 프로그램을 선택하여 시간대별 예약을 진행해주세요</div>
        </div>

        <div class="card">
            <h3>비즈 마그넷 만들기</h3>
            <div class="program-card">
                <div class="program-image">
                    <img src="magnet.jpg" alt="비즈 마그넷 예시" />
                </div>
                <div class="program-info">
                    <div class="program-status">
                        <span class="badge">예약 가능</span>
                        <span id="magnet-next-time" class="text-small">다음 예약 가능 시간: 로딩 중...</span>
                    </div>
                    <div class="program-description">
                        <p>예쁜 비즈로 나만의 마그넷을 만들어보세요!</p>
                        <p class="text-small">• 체험 시간: 10분</p>
                        <p class="text-small">• 최대 인원: 4명</p>
                    </div>
                    <a href="./reservation-magnet.html" class="btn btn-primary">마그넷 예약하기</a>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>비즈 키링 만들기</h3>
            <div class="program-card">
                        <div class="program-image">
                            <img src="keyring.jpg" alt="비즈 키링 예시" />
                        </div>
                <div class="program-info">
                    <div class="program-status">
                        <span class="badge">예약 가능</span>
                        <span id="keyring-next-time" class="text-small">다음 예약 가능 시간: 로딩 중...</span>
                    </div>
                    <div class="program-description">
                        <p>아름다운 비즈로 나만의 키링을 만들어보세요!</p>
                        <p class="text-small">• 체험 시간: 10분</p>
                        <p class="text-small">• 최대 인원: 4명</p>
                    </div>
                    <a href="./reservation-keyring.html" class="btn btn-primary">키링 예약하기</a>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="row">
                <a href="./waiting.html" style="text-decoration: none;">
                    <button class="btn btn-secondary">내 예약 확인하기</button>
                </a>
                <a href="./administration.html" style="text-decoration: none;">
                    <button class="btn btn-secondary">관리자 페이지</button>
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase 설정 (인라인으로 포함)
        const firebaseConfig = {
            apiKey: "AIzaSyA_YlXZRedGE4dHiIwZ40yc8GDaCoen0Pc",
            authDomain: "delta-3bf19.firebaseapp.com",
            projectId: "delta-3bf19",
            storageBucket: "delta-3bf19.firebasestorage.app",
            messagingSenderId: "975459775271",
            appId: "1:975459775271:web:87d105fecef201e2f96f02"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const RES_COL = collection(db, 'reservations');

        // 시간대 생성 함수 (09:30 ~ 17:45, 15분 단위)
        function generateTimeSlots() {
            const slots = [];
            for (let hour = 9; hour <= 17; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    if (hour === 17 && minute > 45) break;
                    if (hour === 9 && minute < 30) continue;
                    
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    slots.push(timeString);
                }
            }
            return slots;
        }

        // 현재 시간 기준으로 다음 예약 가능 시간 찾기
        function getNextAvailableTime(programType, reservations) {
            const timeSlots = generateTimeSlots();
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${Math.floor(now.getMinutes() / 15) * 15}`;
            
            // 현재 시간 이후의 시간대만 필터링
            const availableSlots = timeSlots.filter(slot => slot > currentTime);
            
            for (const slot of availableSlots) {
                // 해당 시간대의 예약 인원 계산
                const slotReservations = reservations.filter(res => 
                    res.programType === programType && 
                    res.timeSlot === slot && 
                    res.status === 'pending'
                );
                const totalCount = slotReservations.reduce((sum, res) => sum + (res.count || 0), 0);
                
                if (totalCount < 4) {
                    return slot;
                }
            }
            
            return null; // 예약 가능한 시간이 없음
        }

        // 각 프로그램의 다음 예약 가능 시간 표시
        async function updateNextAvailableTimes() {
            try {
                // 모든 예약 데이터 조회
                const q = query(RES_COL);
                const snap = await getDocs(q);
                const reservations = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 키링 다음 예약 가능 시간
                const keyringNextTime = getNextAvailableTime('keyring', reservations);
                const keyringElement = document.getElementById('keyring-next-time');
                if (keyringNextTime) {
                    keyringElement.textContent = `다음 예약 가능 시간: ${keyringNextTime}`;
                } else {
                    keyringElement.textContent = '오늘 예약 가능한 시간이 없습니다';
                }
                
                // 마그넷 다음 예약 가능 시간
                const magnetNextTime = getNextAvailableTime('magnet', reservations);
                const magnetElement = document.getElementById('magnet-next-time');
                if (magnetNextTime) {
                    magnetElement.textContent = `다음 예약 가능 시간: ${magnetNextTime}`;
                } else {
                    magnetElement.textContent = '오늘 예약 가능한 시간이 없습니다';
                }
                
            } catch (error) {
                console.error('예약 가능 시간 조회 중 오류:', error);
                document.getElementById('keyring-next-time').textContent = '시간 조회 중 오류가 발생했습니다';
                document.getElementById('magnet-next-time').textContent = '시간 조회 중 오류가 발생했습니다';
            }
        }

        // 페이지 로드 시 다음 예약 가능 시간 업데이트
        updateNextAvailableTimes();
        
        // 30초마다 업데이트
        setInterval(updateNextAvailableTimes, 30000);
    </script>
</body>
</html>



