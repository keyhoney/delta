<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대구수학페스티벌 - Delta 부스 예약</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Δ</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Δ</div>
            <div>
                <h1>대구수학페스티벌</h1>
                <div class="subtitle">송현여자고등학교 Delta 부스</div>
            </div>
        </header>

        <div class="card">
            <h2>체험 프로그램 예약</h2>
        </div>

        <div class="card">
            <h3>1) 체험 프로그램 선택</h3>
            <div class="description">원하는 체험을 선택하고 인원 수를 입력해주세요</div>
            <div class="row">
                <div class="form-group">
                    <div class="program-item">
                        <label>
                            <input type="checkbox" id="chk-keyring"> 비즈 키링 만들기
                        </label>
                        <div class="program-image">
                            <img src="keyring.jpg" alt="비즈 키링 예시" />
                        </div>
                        <label>체험 희망 인원 수 (최대 4명)
                            <input id="cnt-keyring" type="number" min="1" max="4" value="1" disabled>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="program-item">
                        <label>
                            <input type="checkbox" id="chk-magnet"> 비즈 마그넷 만들기
                        </label>
                        <div class="program-image">
                            <img src="magnet.jpg" alt="비즈 마그넷 예시" />
                        </div>
                        <label>체험 희망 인원 수 (최대 4명)
                            <input id="cnt-magnet" type="number" min="1" max="4" value="1" disabled>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>2) 연락처</h3>
            <div class="form-group">
                <label>휴대폰 번호</label>
                <input id="phone" type="tel" inputmode="numeric" placeholder="010-0000-0000" value="010-" />
            </div>
            <div class="text-small">※ 같은 번호로 추가 예약은 불가능합니다. 필요시 기존 예약을 취소 후 재예약해주세요.</div>
        </div>

        <div class="card">
            <button class="btn btn-primary" id="btn-reserve">예약 등록</button>
            <a href="./waiting.html" style="margin-left: var(--space-3); text-decoration: none;">
                <button class="btn btn-secondary">내 대기 순번 확인하기</button>
            </a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase 설정 (인라인으로 포함)
        const firebaseConfig = {
            apiKey: "AIzaSyA_YlXZRedGE4dHiIwZ40yc8GDaCoen0Pc",
            authDomain: "delta-3bf19.firebaseapp.com",
            projectId: "delta-3bf19",
            storageBucket: "delta-3bf19.firebasestorage.app",
            messagingSenderId: "975459775271",
            appId: "1:975459775271:web:87d105fecef201e2f96f02"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const RES_COL = collection(db, 'reservations');

        const el = id => document.getElementById(id);

        // 체크박스 상태에 따라 인원 수 입력 활성화/비활성화
        el('chk-keyring').addEventListener('change', (e) => {
            el('cnt-keyring').disabled = !e.target.checked;
            if (!e.target.checked) el('cnt-keyring').value = '1';
        });

        el('chk-magnet').addEventListener('change', (e) => {
            el('cnt-magnet').disabled = !e.target.checked;
            if (!e.target.checked) el('cnt-magnet').value = '1';
        });

        // 인원 수 입력 제한 (최대 4명)
        el('cnt-keyring').addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            if (value > 4) {
                e.target.value = '4';
                alert('키링 체험은 최대 4명까지 신청 가능합니다.');
            }
        });

        el('cnt-magnet').addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            if (value > 4) {
                e.target.value = '4';
                alert('마그넷 체험은 최대 4명까지 신청 가능합니다.');
            }
        });

        // 전화번호 포맷팅 함수
        function formatPhoneNumber(phone) {
            // 숫자만 추출
            const numbers = phone.replace(/[^0-9]/g, '');
            
            // 010으로 시작하지 않으면 010 추가
            let formatted = numbers;
            if (!formatted.startsWith('010')) {
                formatted = '010' + formatted;
            }
            
            // 11자리로 제한
            formatted = formatted.substring(0, 11);
            
            // 하이픈 추가
            if (formatted.length >= 3) {
                formatted = formatted.substring(0, 3) + '-' + formatted.substring(3);
            }
            if (formatted.length >= 8) {
                formatted = formatted.substring(0, 8) + '-' + formatted.substring(8);
            }
            
            return formatted;
        }

        // 전화번호 정규화 함수
        function normalizePhone(phone) {
            return phone.replace(/[^0-9]/g, '');
        }

        // 전화번호 입력 이벤트 처리
        el('phone').addEventListener('input', (e) => {
            const input = e.target;
            const cursorPosition = input.selectionStart;
            const oldValue = input.value;
            const oldLength = oldValue.length;
            
            // 포맷팅 적용
            const formatted = formatPhoneNumber(input.value);
            input.value = formatted;
            
            // 커서 위치 조정
            const newLength = formatted.length;
            let newPosition = cursorPosition;
            
            // 하이픈이 추가된 경우 커서 위치 조정
            if (newLength > oldLength) {
                newPosition += newLength - oldLength;
            } else if (newLength < oldLength) {
                newPosition -= oldLength - newLength;
            }
            
            input.setSelectionRange(newPosition, newPosition);
        });

        // 전화번호 입력 필드에서 숫자만 입력 가능하도록
        el('phone').addEventListener('keypress', (e) => {
            const char = String.fromCharCode(e.which);
            if (!/[0-9]/.test(char)) {
                e.preventDefault();
            }
        });

        // 중복 예약 체크 함수
        async function checkExistingReservation(phone) {
            const normalizedPhone = normalizePhone(phone);
            const q = query(RES_COL, where('contact', '==', normalizedPhone));
            const snap = await getDocs(q);
            return !snap.empty;
        }

        document.getElementById('btn-reserve').addEventListener('click', async () => {
            const selKeyring = el('chk-keyring').checked;
            const selMagnet = el('chk-magnet').checked;
            const cntKeyring = parseInt(el('cnt-keyring').value || '0', 10);
            const cntMagnet = parseInt(el('cnt-magnet').value || '0', 10);
            let phone = normalizePhone(el('phone').value);

            // 유효성 검사
            if (!selKeyring && !selMagnet) { 
                alert('최소 하나의 체험을 선택해주세요.'); 
                return; 
            }
            if (selKeyring && (cntKeyring <= 0 || cntKeyring > 4)) { 
                alert('키링 인원 수는 1명~4명 사이로 입력해주세요.'); 
                return; 
            }
            if (selMagnet && (cntMagnet <= 0 || cntMagnet > 4)) { 
                alert('마그넷 인원 수는 1명~4명 사이로 입력해주세요.'); 
                return; 
            }
            if (!/^01\d{8,9}$/.test(phone)) { 
                alert('휴대폰 번호 형식을 확인해주세요.'); 
                return; 
            }

            // 중복 예약 체크
            const hasExistingReservation = await checkExistingReservation(phone);
            if (hasExistingReservation) {
                alert('이미 등록된 연락처입니다.\n\n같은 번호로 추가 예약은 불가능합니다.\n필요시 기존 예약을 취소하고 재예약해주세요.');
                return;
            }

            const payload = {
                contact: phone,
                createdAt: serverTimestamp(),
                programs: {
                    keyring: {
                        selected: selKeyring,
                        count: cntKeyring || 0,
                        status: selKeyring ? 'pending' : 'off',
                        enqueuedAt: selKeyring ? serverTimestamp() : null,
                    },
                    magnet: {
                        selected: selMagnet,
                        count: cntMagnet || 0,
                        status: selMagnet ? 'pending' : 'off',
                        enqueuedAt: selMagnet ? serverTimestamp() : null,
                    }
                }
            };

            try {
                const docRef = await addDoc(RES_COL, payload);
                alert('예약이 등록되었습니다! 대기 순번은 "내 대기 순번" 페이지에서 확인하세요.');
                window.location.href = './waiting.html?phone=' + encodeURIComponent(phone);
            } catch (e) {
                console.error(e);
                alert('예약 중 오류가 발생했습니다. 네트워크 상태를 확인해주세요.');
            }
        });
    </script>
</body>
</html>
